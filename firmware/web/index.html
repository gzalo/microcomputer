<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microcomputer - 8080 Emulator</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Arial', sans-serif;
            background: #ececec;
            min-height: 100vh;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .microcomputer {
            width: 800px;
            margin: 0 auto;
        }

        /* Top section with LCD - angled appearance */
        .top-section {
            background: linear-gradient(180deg, #777 0%, #828282 100%);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: none;
            box-shadow: inset 0 2px 4px rgba(255,255,255,0.1);
        }

        .key-switch {
            width: 30px;
            height: 30px;
            background: radial-gradient(circle at 30% 30%, #666, #333);
            border-radius: 50%;
            border: 2px solid #222;
            cursor: pointer;
            position: relative;
        }
        .key-switch::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 12px;
            height: 4px;
            background: #111;
            transform: translate(-50%, -50%) rotate(0deg);
            transition: transform 0.2s;
        }
        .key-switch.on::after {
            transform: translate(-50%, -50%) rotate(90deg);
        }

        /* Run mode 3-position switch */
        .run-mode-switch {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }
        .run-mode-label {
            font-size: 8px;
            color: #aaa;
        }
        .three-pos-switch {
            width: 20px;
            height: 40px;
            background: linear-gradient(90deg, #555 0%, #777 50%, #555 100%);
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            border: 1px solid #333;
        }
        .three-pos-switch::before {
            content: '';
            position: absolute;
            left: 2px;
            right: 2px;
            height: 14px;
            background: linear-gradient(180deg, #ccc 0%, #999 50%, #bbb 100%);
            border-radius: 3px;
            top: 50%;
            transform: translateY(-50%);
            transition: all 0.1s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.4);
        }
        .three-pos-switch.up::before {
            top: 4px;
            transform: translateY(0);
        }
        .three-pos-switch.down::before {
            top: auto;
            bottom: 4px;
            transform: translateY(0);
        }

        /* LCD Display */
        .lcd-container {
            background: #1a1a1a;
            border: 3px solid #444;
            border-radius: 4px;
            padding: 4px;
        }
        .lcd {
            background: #4a6b2a;
            padding: 8px 12px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            color: #1a3a0a;
            letter-spacing: 2px;
            min-width: 280px;
        }
        .lcd-line {
            height: 22px;
            white-space: pre;
        }
        .lcd.on {
            color: #15223c;
            text-shadow: 0 0 2px #4a7a2a;
        }
        .lcd-cursor {
            text-decoration: underline;
        }
        @keyframes blink {
            0%, 49% { background: #2a4a1a; color: #4a6b2a; }
            50%, 100% { background: transparent; }
        }

        /* Main front panel */
        .front-panel {
            background: linear-gradient(180deg, #a8a8a8 0%, #888 5%, #999 50%, #888 95%, #777 100%);
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
        }

        /* Left side - switches and LEDs */
        .switch-led-area {
            padding: 15px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .title-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #999;
        }
        .title {
            font-family: 'Times New Roman', serif;
            font-size: 24px;
            font-weight: bold;
            color: #333;
            letter-spacing: 3px;
        }
        .badge {
            background: #333;
            color: #ddd;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }

        /* LED and switch rows */
        .row-group {
            margin-bottom: 15px;
        }
        .row-label {
            font-size: 10px;
            color: #555;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }

        .led-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 10px;
        }
        .led {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #6a3a3a, #3a1a1a);
            border: 2px solid #333;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }
        .led.on {
            background: radial-gradient(circle at 30% 30%, #ff6666, #cc0000);
            box-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000, inset 0 -2px 4px rgba(0,0,0,0.3);
        }

        .switch-row {
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        .toggle-switch {
            width: 22px;
            height: 44px;
            background: linear-gradient(90deg, #555 0%, #888 50%, #555 100%);
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            border: 2px solid #444;
        }
        .toggle-switch::before {
            content: '';
            position: absolute;
            left: 2px;
            right: 2px;
            height: 20px;
            background: linear-gradient(180deg, #ddd 0%, #aaa 50%, #ccc 100%);
            border-radius: 3px;
            bottom: 3px;
            transition: all 0.1s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4);
        }
        .toggle-switch.on::before {
            bottom: auto;
            top: 3px;
        }

        .bit-labels {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 6px;
        }
        .bit-label {
            width: 22px;
            text-align: center;
            font-size: 10px;
            color: #444;
        }
        .bit-label-main {
            font-weight: bold;
            font-size: 12px;
        }
        .bit-label-sub {
            font-size: 9px;
        }

        /* Right side controls */
        .controls-area {
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-width: 140px;
        }

        .control-group {
            text-align: center;
        }
        .control-label {
            font-size: 10px;
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        .control-sublabel {
            font-size: 8px;
            color: #555;
        }

        /* Circular push buttons */
        .push-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fff, #000);
            border: 2px solid #333;
            cursor: pointer;
            margin: 0 auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4), inset 0 1px 2px rgba(255,255,255,0.2);
            transition: all 0.05s;
        }
        .push-btn:active {
            box-shadow: 0 1px 2px rgba(0,0,0,0.4), inset 0 2px 4px rgba(0,0,0,0.4);
            transform: translateY(1px);
        }

        /* Reset button - larger */
        .reset-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #888, #444);
            border: 3px solid #333;
            cursor: pointer;
            margin: 0 auto;
            box-shadow: 0 3px 6px rgba(0,0,0,0.4), inset 0 1px 2px rgba(255,255,255,0.2);
            transition: all 0.1s;
        }
        .reset-btn:active {
            box-shadow: 0 1px 2px rgba(0,0,0,0.4), inset 0 2px 4px rgba(0,0,0,0.3);
            transform: translateY(2px);
        }
        .reset-btn.pressed {
            box-shadow: 0 1px 2px rgba(0,0,0,0.4), inset 0 2px 4px rgba(0,0,0,0.3);
            transform: translateY(2px);
        }

        /* Control toggles */
        .control-toggle {
            width: 18px;
            height: 32px;
            background: linear-gradient(90deg, #555 0%, #777 50%, #555 100%);
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            border: 1px solid #333;
            margin: 0 auto;
        }
        .control-toggle::before {
            content: '';
            position: absolute;
            left: 2px;
            right: 2px;
            height: 14px;
            background: linear-gradient(180deg, #ccc 0%, #999 50%, #bbb 100%);
            border-radius: 3px;
            bottom: 3px;
            transition: all 0.1s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.4);
        }
        .control-toggle.on::before {
            bottom: auto;
            top: 3px;
        }

        /* Store group */
        .store-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: flex-start;
        }
        .store-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
        }

        /* Auto increment */
        .auto-inc-labels {
            display: flex;
            justify-content: space-between;
            font-size: 8px;
            color: #333;
            width: 26px;
            margin: 0 auto;
        }

        .switch-value-display {
            text-align: center;
            margin-top: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #555;
        }

        /* Program selector bar */
        .program-bar {
            padding: 10px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
        }
        .program-bar select {
            background: #444;
            color: #fff;
            border: 1px solid #555;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }

        /* Registers panel */
        .registers-panel {
            width: 700px;
            margin: 0 auto;
            background: #ddd;
            padding: 15px;
            margin-top: 25px;
        }
        .registers-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .registers-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            font-family: 'Courier New', monospace;
        }
        .reg {
            text-align: center;
        }
        .reg-name {
            font-size: 10px;
            color: #666;
            font-weight: bold;
        }
        .reg-value {
            font-size: 16px;
        }

        /* Status section - at bottom */
        .status-bar {
            width: 700px;
            margin: 0 auto;
            background: #ddd;
            padding: 10px 20px;
            border-radius: 0 0 8px 8px;
            display: flex;
            justify-content: center;
            gap: 30px;
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: #666;
        }
        .status-led {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #333;
            border: 1px solid #444;
        }
        .status-led.running {
            background: radial-gradient(circle at 30% 30%, #6f6, #0a0);
            box-shadow: 0 0 8px #0f0;
        }
        .status-led.halted {
            background: radial-gradient(circle at 30% 30%, #f66, #a00);
            box-shadow: 0 0 8px #f00;
        }

        /* Instructions section */
        .instructions {
            width: 700px;
            margin: 0 auto;
            margin-top: 20px;
            padding: 15px 20px;
            font-size: 12px;
            line-height: 1.6;
        }
        .instructions h3 {
            margin-bottom: 10px;
            font-size: 14px;
        }
        .instructions ul {
            margin-left: 20px;
            margin-bottom: 10px;
        }
        .instructions a {
            color: #4a9;
            text-decoration: none;
        }
        .instructions a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="microcomputer">
        <!-- Top section with LCD -->
        <div class="top-section">
            <div class="key-switch on" id="key-switch" title="Key Switch (toggle LCD view)"></div>
            <div class="lcd-container">
                <div class="lcd on" id="lcd">
                    <div class="lcd-line" id="lcd-line0">8080 Emulator</div>
                    <div class="lcd-line" id="lcd-line1">Ready</div>
                </div>
            </div>
            <!-- Run mode 3-position switch -->
            <div class="run-mode-switch">
                <div class="run-mode-label">SLOW</div>
                <div class="three-pos-switch" id="run-mode-switch" title="Click to cycle: Stop/Slow/Fast"></div>
                <div class="run-mode-label">FAST</div>
            </div>
        </div>

        <!-- Main front panel -->
        <div class="front-panel">
            <!-- Left: switches and LEDs -->
            <div class="switch-led-area">
                <div class="row-group">
                    <div class="led-row" id="led-row-low">
                        <div class="led" data-bit="7"></div>
                        <div class="led" data-bit="6"></div>
                        <div class="led" data-bit="5"></div>
                        <div class="led" data-bit="4"></div>
                        <div class="led" data-bit="3"></div>
                        <div class="led" data-bit="2"></div>
                        <div class="led" data-bit="1"></div>
                        <div class="led" data-bit="0"></div>
                    </div>
                </div>

                <div class="row-group">
                    <div class="switch-row" id="switch-row-low">
                        <div class="toggle-switch" data-bit="7"></div>
                        <div class="toggle-switch" data-bit="6"></div>
                        <div class="toggle-switch" data-bit="5"></div>
                        <div class="toggle-switch" data-bit="4"></div>
                        <div class="toggle-switch" data-bit="3"></div>
                        <div class="toggle-switch" data-bit="2"></div>
                        <div class="toggle-switch" data-bit="1"></div>
                        <div class="toggle-switch" data-bit="0"></div>
                    </div>
                    <div class="bit-labels">
                        <div class="bit-label"><div class="bit-label-main">7</div><div class="bit-label-sub">128</div></div>
                        <div class="bit-label"><div class="bit-label-main">6</div><div class="bit-label-sub">64</div></div>
                        <div class="bit-label"><div class="bit-label-main">5</div><div class="bit-label-sub">32</div></div>
                        <div class="bit-label"><div class="bit-label-main">4</div><div class="bit-label-sub">16</div></div>
                        <div class="bit-label"><div class="bit-label-main">3</div><div class="bit-label-sub">8</div></div>
                        <div class="bit-label"><div class="bit-label-main">2</div><div class="bit-label-sub">4</div></div>
                        <div class="bit-label"><div class="bit-label-main">1</div><div class="bit-label-sub">2</div></div>
                        <div class="bit-label"><div class="bit-label-main">0</div><div class="bit-label-sub">1</div></div>
                    </div>
                </div>

                <div class="row-group">
                    <div class="led-row" id="led-row-high">
                        <div class="led" data-bit="15"></div>
                        <div class="led" data-bit="14"></div>
                        <div class="led" data-bit="13"></div>
                        <div class="led" data-bit="12"></div>
                        <div class="led" data-bit="11"></div>
                        <div class="led" data-bit="10"></div>
                        <div class="led" data-bit="9"></div>
                        <div class="led" data-bit="8"></div>
                    </div>
                </div>

                <div class="row-group">
                    <div class="switch-row" id="switch-row-high">
                        <div class="toggle-switch" data-bit="15"></div>
                        <div class="toggle-switch" data-bit="14"></div>
                        <div class="toggle-switch" data-bit="13"></div>
                        <div class="toggle-switch" data-bit="12"></div>
                        <div class="toggle-switch" data-bit="11"></div>
                        <div class="toggle-switch" data-bit="10"></div>
                        <div class="toggle-switch" data-bit="9"></div>
                        <div class="toggle-switch" data-bit="8"></div>
                    </div>
                    <div class="bit-labels">
                        <div class="bit-label"><div class="bit-label-main">7</div><div class="bit-label-sub">128</div></div>
                        <div class="bit-label"><div class="bit-label-main">6</div><div class="bit-label-sub">64</div></div>
                        <div class="bit-label"><div class="bit-label-main">5</div><div class="bit-label-sub">32</div></div>
                        <div class="bit-label"><div class="bit-label-main">4</div><div class="bit-label-sub">16</div></div>
                        <div class="bit-label"><div class="bit-label-main">3</div><div class="bit-label-sub">8</div></div>
                        <div class="bit-label"><div class="bit-label-main">2</div><div class="bit-label-sub">4</div></div>
                        <div class="bit-label"><div class="bit-label-main">1</div><div class="bit-label-sub">2</div></div>
                        <div class="bit-label"><div class="bit-label-main">0</div><div class="bit-label-sub">1</div></div>
                    </div>
                </div>
            </div>

            <!-- Right: control buttons -->
            <div class="controls-area">
                <!-- Reset -->
                <div class="control-group">
                    <div class="reset-btn" id="btn-reset"></div>
                    <div class="control-label">RESET</div>
                    <div class="control-sublabel">PC=0</div>
                </div>

                <!-- Single Step -->
                <div class="control-group">
                    <div class="push-btn blue" id="btn-step"></div>
                    <div class="control-label">SINGLE<br>STEP</div>
                </div>

                <!-- Store -->
                <div class="control-group">
                    <div class="control-label">STORE</div>
                    <div class="store-group">
                        <div class="store-item">
                            <div class="push-btn" id="btn-store-addr"></div>
                            <div class="control-sublabel">ADDR</div>
                        </div>
                        <div class="store-item">
                            <div class="push-btn" id="btn-store-byte"></div>
                            <div class="control-sublabel">BYTE</div>
                        </div>
                        <div class="store-item">
                            <div class="push-btn" id="btn-store-word"></div>
                            <div class="control-sublabel">WORD</div>
                        </div>
                    </div>
                </div>

                <!-- Auto Increment -->
                <div class="control-group">
                    <div class="control-toggle" id="btn-auto-inc"></div>
                    <div class="control-label">AUTO<br>INCREMENT</div>
                    <div class="auto-inc-labels">
                        <span>Y</span>
                        <span>N</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Registers panel -->
    <div class="registers-panel">
        <div class="registers-title">CPU Registers</div>
        <div class="registers-grid">
            <div class="reg"><div class="reg-name">A</div><div class="reg-value" id="reg-a">00</div></div>
            <div class="reg"><div class="reg-name">BC</div><div class="reg-value" id="reg-bc">0000</div></div>
            <div class="reg"><div class="reg-name">DE</div><div class="reg-value" id="reg-de">0000</div></div>
            <div class="reg"><div class="reg-name">HL</div><div class="reg-value" id="reg-hl">0000</div></div>
            <div class="reg"><div class="reg-name">SP</div><div class="reg-value" id="reg-sp">0000</div></div>
            <div class="reg"><div class="reg-name">PC</div><div class="reg-value" id="reg-pc">0000</div></div>
            <div class="reg"><div class="reg-name">Flags</div><div class="reg-value" id="reg-f">00</div></div>
            <div class="reg" style="grid-column: span 3;"><div class="reg-name">S Z - AC - P - C</div><div class="reg-value" id="flags">- - - -- - - - -</div></div>
        </div>
    </div>

    <!-- Status bar at bottom -->
    <div class="status-bar">
        <div class="status-item">
            <div class="status-led" id="status-running"></div>
            <span>Running</span>
        </div>
        <div class="status-item">
            <div class="status-led" id="status-halted"></div>
            <span>Halted</span>
        </div>
    </div>

    <!-- Program selector bar -->
    <div class="program-bar">
        <label>Program: </label>
        <select id="program-select">
            <option value="0">None (Manual)</option>
            <option value="1">Counter</option>
            <option value="2">Memory Fill</option>
            <option value="3">Fibonacci</option>
            <option value="4">Delay Count</option>
            <option value="5">Stack Test</option>
        </select>
    </div>

    <!-- Instructions -->
    <div class="instructions">
        <h3>Instructions</h3>
        <ul>
            <li><strong>Key Switch</strong> (top left): Toggle register/memory view</li>
            <li><strong>Run Mode Switch</strong> (top right): Click to cycle Stop / Slow / Fast</li>
            <li><strong>Toggle Switches</strong>: Set 16-bit address or 8/16-bit data (top row is lower byte)</li>
            <li><strong>RESET</strong>: Reset the CPU (PC = 0) or loads a program from the predefined ones</li>
            <li><strong>SINGLE STEP</strong>: Execute one instruction</li>
            <li><strong>STORE ADDR</strong>: Set the current address/program counter from switches</li>
            <li><strong>STORE BYTE</strong>: Write (top) byte to memory at current address</li>
            <li><strong>STORE WORD</strong>: Write both bytes to memory</li>
            <li><strong>AUTO INCREMENT</strong>: Automatically increment address after store</li>
        </ul>
        <p>Source code: <a href="https://github.com/gzalo/microcomputer" target="_blank">github.com/gzalo/microcomputer</a></p>
    </div>

    <script src="emulator.js"></script>
    <script>
        // Wait for WASM module to load
        Module.onRuntimeInitialized = function() {
            console.log('Emulator initialized');
            initUI();
            requestAnimationFrame(mainLoop);
        };

        // Button bit mappings (from microcomputer.h)
        const INPUT_STOP_RUN_BIT1 = 0x001;
        const INPUT_STOP_RUN_BIT2 = 0x002;
        const INPUT_SINGLE_STEP   = 0x004;
        const INPUT_RESET         = 0x008;
        const INPUT_STORE_ADDR    = 0x010;
        const INPUT_STORE_BYTE    = 0x020;
        const INPUT_STORE_WORD    = 0x040;
        const INPUT_AUTO_INC      = 0x080;
        const INPUT_KEY_SWITCH    = 0x100;

        // State
        let switchValue = 0;
        let buttonState = INPUT_KEY_SWITCH; // Start with key turned on
        let startTime = performance.now();
        let runMode = 0; // 0=stop, 1=slow, 2=fast

        // Get exported functions
        function getExports() {
            return {
                emu_init: Module.cwrap('emu_init', null, []),
                emu_set_time: Module.cwrap('emu_set_time', null, ['number']),
                emu_update: Module.cwrap('emu_update', null, ['number', 'number']),
                emu_get_lcd_line: Module.cwrap('emu_get_lcd_line', 'string', ['number']),
                emu_get_lcd_cursor_col: Module.cwrap('emu_get_lcd_cursor_col', 'number', []),
                emu_get_lcd_cursor_row: Module.cwrap('emu_get_lcd_cursor_row', 'number', []),
                emu_get_lcd_cursor_on: Module.cwrap('emu_get_lcd_cursor_on', 'number', []),
                emu_get_led_pattern: Module.cwrap('emu_get_led_pattern', 'number', []),
                emu_get_pc: Module.cwrap('emu_get_pc', 'number', []),
                emu_get_reg_a: Module.cwrap('emu_get_reg_a', 'number', []),
                emu_get_reg_f: Module.cwrap('emu_get_reg_f', 'number', []),
                emu_get_reg_b: Module.cwrap('emu_get_reg_b', 'number', []),
                emu_get_reg_c: Module.cwrap('emu_get_reg_c', 'number', []),
                emu_get_reg_d: Module.cwrap('emu_get_reg_d', 'number', []),
                emu_get_reg_e: Module.cwrap('emu_get_reg_e', 'number', []),
                emu_get_reg_h: Module.cwrap('emu_get_reg_h', 'number', []),
                emu_get_reg_l: Module.cwrap('emu_get_reg_l', 'number', []),
                emu_get_sp: Module.cwrap('emu_get_sp', 'number', []),
                emu_is_halted: Module.cwrap('emu_is_halted', 'number', []),
                emu_get_run_mode: Module.cwrap('emu_get_run_mode', 'number', [])
            };
        }

        let emu;

        function initUI() {
            emu = getExports();

            // Toggle switch click handlers
            document.querySelectorAll('.toggle-switch').forEach(sw => {
                sw.addEventListener('click', () => {
                    const bit = parseInt(sw.dataset.bit);
                    switchValue ^= (1 << bit);
                    sw.classList.toggle('on');
                });
            });

            // Key switch toggle
            const keySwitch = document.getElementById('key-switch');
            keySwitch.addEventListener('click', () => {
                keySwitch.classList.toggle('on');
                if (keySwitch.classList.contains('on')) {
                    buttonState |= INPUT_KEY_SWITCH;
                } else {
                    buttonState &= ~INPUT_KEY_SWITCH;
                }
            });

            // Run mode 3-position switch
            const runModeSwitch = document.getElementById('run-mode-switch');
            runModeSwitch.addEventListener('click', () => {
                // Cycle: middle (stop) -> up (slow) -> down (fast) -> middle
                runMode = (runMode + 1) % 3;
                updateRunModeSwitch();
                updateRunModeBits();
            });

            // Program selector - set switches to program number
            document.getElementById('program-select').addEventListener('change', (e) => {
                const val = parseInt(e.target.value);
                switchValue = (switchValue & 0xFF00) | val;
                updateSwitchUI();

                // Simulate a short RESET button press when changing programs
                const resetBtn = document.getElementById('btn-reset');
                // add visual pressed state
                resetBtn.classList.add('pressed');
                // set the input bit for reset
                buttonState |= INPUT_RESET;
                // release after a short delay
                setTimeout(() => {
                    buttonState &= ~INPUT_RESET;
                    resetBtn.classList.remove('pressed');
                }, 200);
            });

            // Momentary push buttons
            setupMomentaryButton('btn-reset', INPUT_RESET);
            setupMomentaryButton('btn-step', INPUT_SINGLE_STEP);
            setupMomentaryButton('btn-store-addr', INPUT_STORE_ADDR);
            setupMomentaryButton('btn-store-byte', INPUT_STORE_BYTE);
            setupMomentaryButton('btn-store-word', INPUT_STORE_WORD);

            // Auto increment toggle (inverted - up = disabled)
            const autoIncBtn = document.getElementById('btn-auto-inc');
            buttonState |= INPUT_AUTO_INC; // Start disabled
            autoIncBtn.addEventListener('click', () => {
                autoIncBtn.classList.toggle('on');
                if (autoIncBtn.classList.contains('on')) {
                    buttonState &= ~INPUT_AUTO_INC; // ON = enabled = bit off
                } else {
                    buttonState |= INPUT_AUTO_INC; // OFF = disabled = bit on
                }
            });
        }

        function updateRunModeSwitch() {
            const sw = document.getElementById('run-mode-switch');
            sw.classList.remove('up', 'down');
            if (runMode === 1) sw.classList.add('up');      // Slow
            else if (runMode === 2) sw.classList.add('down'); // Fast
            // runMode === 0 is middle (no class)
        }

        function updateRunModeBits() {
            buttonState &= ~(INPUT_STOP_RUN_BIT1 | INPUT_STOP_RUN_BIT2);
            if (runMode === 1) {
                buttonState |= INPUT_STOP_RUN_BIT1; // Slow
            } else if (runMode === 2) {
                buttonState |= INPUT_STOP_RUN_BIT1 | INPUT_STOP_RUN_BIT2; // Fast
            }
        }

        function setupMomentaryButton(id, mask) {
            const btn = document.getElementById(id);
            const activate = () => { buttonState |= mask; };
            const deactivate = () => { buttonState &= ~mask; };

            btn.addEventListener('mousedown', activate);
            btn.addEventListener('mouseup', deactivate);
            btn.addEventListener('mouseleave', deactivate);
            btn.addEventListener('touchstart', (e) => { e.preventDefault(); activate(); });
            btn.addEventListener('touchend', deactivate);
        }

        function updateSwitchUI() {
            document.querySelectorAll('.toggle-switch').forEach(sw => {
                const bit = parseInt(sw.dataset.bit);
                sw.classList.toggle('on', (switchValue & (1 << bit)) !== 0);
            });
        }

        function updateDisplay() {
            // Update LCD
            const line0 = emu.emu_get_lcd_line(0);
            const line1 = emu.emu_get_lcd_line(1);
            const cursorCol = emu.emu_get_lcd_cursor_col();
            const cursorRow = emu.emu_get_lcd_cursor_row();
            const cursorOn = emu.emu_get_lcd_cursor_on();

            document.getElementById('lcd-line0').innerHTML = formatLcdLine(line0, cursorOn && cursorRow === 0 ? cursorCol : -1);
            document.getElementById('lcd-line1').innerHTML = formatLcdLine(line1, cursorOn && cursorRow === 1 ? cursorCol : -1);

            // Update LEDs
            const ledPattern = emu.emu_get_led_pattern();
            document.querySelectorAll('.led').forEach(led => {
                const bit = parseInt(led.dataset.bit);
                led.classList.toggle('on', (ledPattern & (1 << bit)) !== 0);
            });

            // Update registers
            const a = emu.emu_get_reg_a();
            const b = emu.emu_get_reg_b();
            const c = emu.emu_get_reg_c();
            const d = emu.emu_get_reg_d();
            const e = emu.emu_get_reg_e();
            const h = emu.emu_get_reg_h();
            const l = emu.emu_get_reg_l();
            const f = emu.emu_get_reg_f();

            document.getElementById('reg-a').textContent = a.toString(16).toUpperCase().padStart(2, '0');
            document.getElementById('reg-bc').textContent = ((b << 8) | c).toString(16).toUpperCase().padStart(4, '0');
            document.getElementById('reg-de').textContent = ((d << 8) | e).toString(16).toUpperCase().padStart(4, '0');
            document.getElementById('reg-hl').textContent = ((h << 8) | l).toString(16).toUpperCase().padStart(4, '0');
            document.getElementById('reg-pc').textContent = emu.emu_get_pc().toString(16).toUpperCase().padStart(4, '0');
            document.getElementById('reg-sp').textContent = emu.emu_get_sp().toString(16).toUpperCase().padStart(4, '0');
            document.getElementById('reg-f').textContent = f.toString(16).toUpperCase().padStart(2, '0');

            // Update flags display
            const flagStr = [
                (f & 0x80) ? 'S' : '-',
                (f & 0x40) ? 'Z' : '-',
                '-',
                (f & 0x10) ? 'AC' : '--',
                '-',
                (f & 0x04) ? 'P' : '-',
                '-',
                (f & 0x01) ? 'C' : '-'
            ].join(' ');
            document.getElementById('flags').textContent = flagStr;

            // Update status
            const emuRunMode = emu.emu_get_run_mode();
            const halted = emu.emu_is_halted();
            document.getElementById('status-running').classList.toggle('running', emuRunMode !== 0 && !halted);
            document.getElementById('status-halted').classList.toggle('halted', halted);
        }

        function formatLcdLine(text, cursorPos) {
            text = (text || '').padEnd(20, ' ').substring(0, 20);
            if (cursorPos >= 0 && cursorPos < 20) {
                return escapeHtml(text.substring(0, cursorPos)) +
                    '<span class="lcd-cursor">' + escapeHtml(text[cursorPos]) + '</span>' +
                    escapeHtml(text.substring(cursorPos + 1));
            }
            return escapeHtml(text);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function mainLoop(timestamp) {
            const elapsed = Math.floor(timestamp - startTime);
            emu.emu_set_time(elapsed);
            emu.emu_update(switchValue, buttonState);
            updateDisplay();
            requestAnimationFrame(mainLoop);
        }
    </script>
</body>
</html>
